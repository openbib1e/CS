# Chapter06. 메모리와 캐시 메모리

# 06-3. 캐시 메모리

CPU가 메모리에 접근하는 시간은 CPU의 연산 속도보다 느리다.

CPU가 아무리 빠르게 연산을 한다고 해도 메모리에 접근하는 시간이 느리다면 성능 향상에 도움이 되지 않는다.

이를 극복하기 위한 저장 장치가 바로 **캐시 메모리**이다.

## 저장 장치 계층 구조

저장 장치는 일반적으로 아래 두 명제를 따른다.

1. CPU와 가까운 저장 장치는 빠르고, 멀리 있는 저장 장치는 느리다.
2. 속도가 빠른 저장 장치는 저장 용량이 작고, 가격이 비싸다.

레지스터, 메모리(RAM), USB 메모리를 비교해보면,  
CPU와 가장 가까운 레지스터는 일반적으로 RAM보다 용량은 작지만 접근 시간이 압도적으로 빠르고 가격이 비싸다.  
USB 메모리보다 CPU에 가까운 RAM은 접근 시간이 훨씬 빠르지만 같은 용량이어도 가격이 더 비싸다.

즉, 낮은 가격대의 대용량 저장 장치를 원한다면 느린 속도는 감수해야 하고,  
빠른 속도의 저장 장치를 원한다면 작은 용량과 비싼 가격은 감수해야 한다.

그래서 일반적으로 컴퓨터는 다양한 저장 장치를 모두 사용하게 되고,  
컴퓨터가 사용하는 저장 장치들을 **CPU에 얼마나 가까운가**를 기준으로 계층적으로 나타내어 `저장 장치 계층 구조`(memory hierarchy)라고 한다.

## 캐시 메모리

- CPU와 메모리 사이에 위치한, 레지스터보다 용량이 크고 메모리보다 빠른 SRAM 기반의 저장 장치
- CPU의 연산 속도와 메모리 접근 속도의 차이를 조금이나마 줄이기 위해 탄생
- CPU가 매번 메모리에 접근하는 시간이 오래 걸리니 일부 데이터를 미리 캐시 메모리에 가져옴

컴퓨터 내부에는 여러 개의 캐시 메모리를 갖게 되는데,  
이 캐시 메모리들은 CPU와 가까운 순서대로 계층을 구성한다.

제일 가까운 캐시 메모리를 L1(level 1) 캐시, 그다음 가까운 캐시 메모리를 L2(level 2) 캐시, 그다음 가까운 캐시 메모리를 L3(level 3) 캐시라고 부른다.  
일반적으로 L1, L2 캐시는 코어 내부에 위치하고, L3 캐시는 코어 외부에 위치한다.

캐시 메모리 용량은 L1 < L2 < L3

캐시 메모리 속도는 L3 < L2 < L1

가격은 일반적으로 L3 < L2 < L1

CPU가 메모리 내에 데이터가 필요하다고 판단하면 우선 L1 캐시에 해당 데이터가 있는지 알아보고,  
없다면 L2, L3 순서대로 데이터를 검색한다.

### 분리형 캐시

코어와 가장 가까운 L1 캐시는 조금이라도 접근 속도를 빠르게 만들기 위해 명령어만 저장하는 L1 캐시인 L1I 캐시와,  
데이터만을 저장하는 L1 캐시인 L1D 캐시로 분리하는 경우가 있다.

이를 **분리형 캐시**(split cache)라고 한다.

## 참조 지역성 원리

캐시 메모리는 메모리보다 용량이 작기 때문에 당연하게도 메모리의 일부 내용만 저장할 수 있다.

보조기억장치는 전원이 꺼져도 기억할 대상을 저장하고, 메모리는 실행 중인 대상을 저장한다면  
캐시 메모리는 CPU가 사용항 법한 대상을 예측하여 저장한다.

이 때 자주 사용될 것으로 예측한 데이터가 실제로 들어맞아 캐시 메모리 내 데이터가 CPU에서 활용될 경우 **캐시 히트**(cache hit)라고 한다.

반대로 예측하여 캐시 메모리에 저장했지만, 예측이 틀려 메모리에서 필요한 데이터를 직접 가져와야 하는 경우 **캐시 미스**(cache miss)라고 한다.  
캐시 미스가 발생하면 CPU가 필요한 데이터를 메모리에 직접 가져와야 하기 때문에 캐시 메모리의 이점을 사용하지 못 하고 성능이 떨어지게 된다.

### 캐시 적중률

캐시가 히트되는 비율을 **캐시 적중률**(cache hit ratio)이라고 한다.

`캐시 히트 횟수 / (캐시 히트 횟수 + 캐시 미스 횟수)`

우리가 사용하는 컴퓨터의 캐시 적중률은 85~95% 이상이다.  
캐시 적중률이 높으면 CPU의 메모리 접근 횟수를 줄여서 캐시 메모리 이점을 제대로 활용할 수 있다.

캐시 메모리는 `참조 지역성의 원리`(locality of reference, principle of locality)라는 한 가지 원칙에 따라 메모리로부터 가져올 데이터를 결정한다.

참조 지역성의 원리란 CPU가 메모리에 접근할 때의 주된 경향을 바탕으로 만들어진 원리이다.

1. CPU는 최근에 접근했던 메모리 공간에 다시 접근하려는 경향이 있다.
    - 프로그래밍 언어에서 **변수**에 값을 저장하면 언제든 변수에 다시 접근하여 값을 사용할 수 있다.
    - CPU는 변수가 저장된 메모리 공간을 언제든 다시 참조할 수 있다는 것을 의미한다.
    - 최근에 접근했던 메모리 공간에 다시 접근하려는 경향을 **시간 지역성**(temporal locality)이라고 한다.
2. CPU는 접근한 메모리 공간 근처를 접근하려는 경향이 있다.
    - 프로그램은 보통 관련 데이터들끼리 모여있다.
    - 하나의 프로그램 내에서도 관련 데이터들은 모여서 저장된다.
    - 접근한 메모리 공간 근처를 접근하려는 경향을 **공간 지역성**(spatial locality)이라고 한다.

