# Chapter04. CPU의 작동 원리

# 04-3. 명령어 사이클과 인터럽트

## 명령어 사이클

프로그램 속 명령어들은 일정한 주기가 반복되며 실행하고, 이 주기를 **명령어 사이클**(instruction cycle)이라고 한다.

먼저 메모리에서 명령어를 CPU로 가져오는 첫 번째 과정을 **인출 사이클**(fetch cycle)이라고 한다.

메모리로부터 인출한 명령어를 CPU에서 실행하는 두 번째 과정을 **실행 사이클**(execution cycle)이라고 한다.

명령어 사이클은 인출과 실행 두 사이클을 계속 반복한다.

하지만 모든 명령어가 이렇게 간단하게 실행되지는 않는다.  
간접 주소 지정 방식의 경우 메모리 접근을 한 번 더 해야하기 때문에 명령어 인출 후 바로 실행 사이클 단계에 돌입하지 않고 **간접 사이클**(indirect cycle)을 추가해야 한다.

이러한 명령어는 인출, 간접, 실행 사이클을 거쳐서 실행하게 된다.

## 인터럽트

명령어 사이클이 정상적으로만 작동된다면 문제가 없겠지만 CPU가 수행 중인 작업은 방해를 받아 잠시 중단될 수 있다.

이 경우를 **인터럽트**(interrupt)라고 한다.  
인터럽트는 영어로 '방해하다, 중단시키다'를 의미한다.

### 동기 인터럽트(예외)

동기 인터럽트(synchronous interrupts)는 CPU에 의해 발생하는 인터럽트로, CPU가 명령어들을 수행하다가 예상치 못한 상황에 마주쳤을 때 발생한다.

CPU가 실행하는 프로그래밍상의 오류와 같은 예외적인 상황에 마주쳤을 때 발생해서 예외, exception으로 부른다.

이 예외에는 폴트, 트랩, 중단, 소프트웨어 인터럽트 4가지가 있다.

### 비동기 인터럽트(하드웨어 인터럽트)

비동기 인터럽트(asynchronous interrupts)는 주로 입출력장치에 의해 발생하는 인터럽트로 알림과 같은 역할을 한다.

#### 하드웨어 인터럽트

하드웨어 인터럽트는 알림과 같은 인터럽트다.  
입출력 작업 도중에도 효율적으로 명령어를 처리하기 위해 하드웨어 인터럽트를 사용한다.

예를 들어 CPU가 프린터에 출력을 명령했다고 가정하면,  
프린터의 일처리는 CPU보다 훨씬 느리기 때문에 CPU는 프린터의 작업 결과를 바로 받아볼 수 없다.

이 때 하드웨어 인터럽트를 사용하지 않는다면 언제 끝날지 모르는 프린터의 결과를 CPU가 주기적으로 확인해야된다.

하드웨어 인터럽트를 사용하면 CPU가 다른 일을 처리하는 동안 프린터가 일처리를 끝내면 CPU에 알림을 보내서 작업 결과를 알려줄 수 있다.

#### 하드웨어 인터럽트 처리 순서

인터럽트의 종류를 막론하고 인터럽트 처리 순서는 대동소이하다.

1. 입출력장치는 CPU에 **인터럽트 요청 신호**를 보낸다.
    - 인터럽트는 CPU의 정상적인 실행 흐름을 끊는 것이기에 입출력장치가 끼어들기 전 CPU에 인터럽트 요청 신호가 필요함
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인한다.
3. CPU는 인터럽트 요청을 확인하고 **인터럽트 플래그**를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인한다.
    - CPU가 인터럽트 요청을 수용하기 위해서는 플래그 레지스터의 인터럽트 플래그가 활성화되어 있어야 함
    - 하드웨어 인터럽트를 받아들일지, 무시할지 결정
    - CPU가 중요한 작업을 처리하느라 어떠한 작업도 받지 않아야 하는 상황에서 인터럽트 요청 불가능으로 설정되어 요청을 무시하는 경우도 있음
    - 인터럽트 플래그가 불가능으로 설정되어 있어도 무시할 수 없는 요청이 존재함. 가장 우선순위가 높은 인터럽트.
    - 막을 수 있는 인터럽트(maskable interrupt)와 막을 수 없는 인터럽트(non maskable interrupt)로 나눌 수 있음
4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업한다.
5. CPU는 **인터럽트 벡터**를 참조하여 **인터럽트 서비스 루틴**을 실행한다.
    - 인터럽트 요청을 받아들이기로 했다면 인터럽트를 처리하기 위한 프로그램인 인터럽트 서비스 루틴 실행
    - 인터럽트 서비스 루틴은 입출력장치마다 다르기 때문에 CPU는 이를 구분하기 위해 인터럽트 벡터를 사용해서 각각의 인터럽트 서비스 루틴을 식별하고 시작 주소를 알 수 있음
6. 인터럽트 서비스 루틴 실행이 끝나면 백업해 둔 작업을 복구하여 실행을 재개한다.
    - 인터럽스 서비스 루틴을 실행하기 전 기존 수행 작업들은 모두 스택에 백업